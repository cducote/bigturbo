name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests and deploy immediately'
        required: false
        type: boolean
        default: false

jobs:
  validate:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run full quality checks
        if: ${{ !inputs.skip_tests }}
        run: |
          npm run lint
          npm run type-check

      - name: Build production bundle
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_URL: ${{ secrets.PRODUCTION_APP_URL }}
        run: npm run build

      - name: Validate environment variables
        run: |
          if [ -z "${{ secrets.PRODUCTION_APP_URL }}" ]; then
            echo "Error: PRODUCTION_APP_URL not set"
            exit 1
          fi
          echo "Environment validation passed"

  deploy-vercel:
    name: Deploy to Vercel Production
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 10
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

      - name: Output deployment URL
        run: |
          echo "Deployment URL: ${{ steps.deploy.outputs.url }}"
          echo "Preview URL: ${{ steps.deploy.outputs.preview-url }}"

  smoke-tests:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-vercel
    timeout-minutes: 10

    steps:
      - name: Wait for deployment to be ready
        run: sleep 30

      - name: Health check
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_APP_URL }}/api/health)
          if [ $RESPONSE -ne 200 ]; then
            echo "Health check failed with status: $RESPONSE"
            exit 1
          fi
          echo "Health check passed"

      - name: Test homepage
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_APP_URL }})
          if [ $RESPONSE -ne 200 ]; then
            echo "Homepage check failed with status: $RESPONSE"
            exit 1
          fi
          echo "Homepage check passed"

      - name: Test about page
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_APP_URL }}/about)
          if [ $RESPONSE -ne 200 ]; then
            echo "About page check failed with status: $RESPONSE"
            exit 1
          fi
          echo "About page check passed"

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: failure()
    timeout-minutes: 5

    steps:
      - name: Trigger rollback
        run: |
          echo "Smoke tests failed - manual rollback required"
          echo "To rollback, visit: https://vercel.com/${{ secrets.VERCEL_ORG_ID }}/${{ secrets.VERCEL_PROJECT_ID }}/deployments"
          exit 1

  notify-success:
    name: Notify Deployment Success
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: success()

    steps:
      - name: Deployment successful
        run: |
          echo "Production deployment successful"
          echo "Application URL: ${{ secrets.PRODUCTION_APP_URL }}"
          echo "Deployment time: $(date)"
